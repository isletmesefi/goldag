<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Saha Navigasyon - Göldağ</title>

  <!-- Leaflet + MarkerCluster + Proj4 -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/proj4@2.9.2/dist/proj4.js"></script>

  <link href="https://api.fontshare.com/v2/css?f[]=satoshi@900,700,500,400&display=swap" rel="stylesheet">

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    html, body{height:100%;overflow:hidden;background:#0f172a;font-family:'Satoshi',sans-serif}
    #map{height:100%;width:100%;background:#1e293b;display:none}

    /* --- GİRİŞ EKRANI --- */
    #loginScreen{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:radial-gradient(circle at 50% 0%, #334155 0%, #0f172a 60%, #020617 100%);
      z-index:5000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;
    }
    .login-container{
      background:rgba(255,255,255,0.03);
      backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);
      border:1px solid rgba(255,255,255,0.08);
      border-top:1px solid rgba(255,255,255,0.15);
      padding:40px 30px;border-radius:22px;width:100%;max-width:380px;text-align:center;
      box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);
      animation:fadeIn .8s ease-out;
    }
    @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .brand-name{font-size:28px;font-weight:900;color:#fff;margin-bottom:4px;letter-spacing:-0.5px;text-shadow:0 2px 10px rgba(0,0,0,0.3)}
    .brand-title{font-size:13px;font-weight:500;color:rgba(255,255,255,0.6);margin-bottom:20px;text-transform:uppercase;letter-spacing:1px}
    .brand-slogan{
      font-size:12px;font-weight:800;color:#ff4747;margin-bottom:35px;text-transform:uppercase;letter-spacing:1.5px;
      position:relative;display:inline-block;
    }
    .brand-slogan::after{
      content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);
      width:40px;height:2px;background:rgba(255,71,71,0.3);border-radius:2px;
    }
    .login-btn{
      display:flex;align-items:center;justify-content:center;gap:12px;
      width:100%;padding:16px;margin-bottom:14px;border:none;border-radius:14px;
      font-family:'Satoshi',sans-serif;font-size:15px;font-weight:700;
      cursor:pointer;transition:all .3s cubic-bezier(0.4,0,0.2,1);position:relative;overflow:hidden;
    }
    .login-btn svg{width:20px;height:20px;fill:currentColor}
    .btn-guest{background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.9);border:1px solid rgba(255,255,255,0.05)}
    .btn-guest:hover{background:rgba(255,255,255,0.15);transform:translateY(-2px)}
    .btn-user{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;box-shadow:0 4px 20px rgba(37,99,235,0.4);border:1px solid rgba(255,255,255,0.1)}
    .btn-user:hover{box-shadow:0 8px 30px rgba(37,99,235,0.6);transform:translateY(-2px)}
    .btn-admin{background:rgba(0,0,0,0.6);color:rgba(255,255,255,0.8);border:1px solid rgba(255,255,255,0.05)}
    .btn-admin:hover{background:rgba(0,0,0,0.9);color:#fff;border-color:rgba(255,255,255,0.2)}
    .version-text{position:absolute;bottom:20px;font-size:11px;color:rgba(255,255,255,0.2);font-weight:500;letter-spacing:0.5px}

    /* Modal */
    #authModal, .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter:blur(5px);z-index:6000;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .auth-box, .modal-content{background:#1e293b;color:#fff;padding:30px;border-radius:20px;width:90%;max-width:350px;border:1px solid rgba(255,255,255,0.1);box-shadow:0 20px 60px rgba(0,0,0,0.5)}
    .auth-input, .modal-content input{
      width:100%;padding:14px;margin-bottom:15px;background:rgba(0,0,0,0.3);
      border:1px solid rgba(255,255,255,0.1);color:#fff;border-radius:10px;font-size:16px;outline:none;transition:.3s;font-family:'Satoshi',sans-serif
    }
    .auth-input:focus{border-color:#3b82f6;background:rgba(0,0,0,0.5)}
    .modal-buttons{display:flex;gap:10px}
    .btn-save{background:#2563eb;color:#fff;flex:1;padding:12px;border:none;border-radius:10px;font-weight:bold;cursor:pointer}
    .btn-cancel{background:rgba(255,255,255,0.1);color:#fff;flex:1;padding:12px;border:none;border-radius:10px;font-weight:bold;cursor:pointer}
    .btn-delete{background:#ef4444;color:#fff;flex:1;padding:12px;border:none;border-radius:10px;font-weight:bold;cursor:pointer}
    .error-msg{color:#ff4747;font-size:14px;margin-bottom:15px;display:none;text-align:center;font-weight:600}

    /* Üst arama */
    .search-box{
      position:absolute;top:20px;left:50%;transform:translateX(-50%);
      width:240px;padding:12px 20px;z-index:1000;border-radius:30px;border:none;
      background:rgba(30,41,59,0.9);color:#fff;backdrop-filter:blur(5px);
      display:none;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.3);
      font-family:'Satoshi',sans-serif;font-size:14px;
    }

    /* Sağ butonlar */
    .action-btn{
      position:absolute;right:20px;width:50px;height:50px;border-radius:16px;border:none;
      cursor:pointer;z-index:1000;box-shadow:0 10px 25px rgba(0,0,0,0.4);
      display:none;align-items:center;justify-content:center;padding:0;color:#fff;transition:all .3s ease;
    }
    .action-btn svg{width:24px;height:24px;fill:currentColor;pointer-events:none}
    #addMarkerBtn{top:20px;background:#2563eb}
    #addMarkerBtn.active{background:#ef4444}
    #lockBtn{top:85px;background:#475569}
    #lockBtn.unlocked{background:#ef4444}
    #gpsBtn{top:150px;background:#16a34a}
    #exportBtn{top:215px;background:#0ea5e9}

    /* Marker */
    .custom-div-icon{background:transparent;border:none}
    .pin-wrapper{position:relative;width:50px;height:60px;pointer-events:none}
    .pin-marker{
      position:absolute;width:36px;height:36px;background:#2563eb;border-radius:50% 50% 50% 0;left:7px;top:0;
      border:3px solid #fff;transform:rotate(-45deg);transition:background .3s;pointer-events:auto;
      box-shadow:0 5px 15px rgba(0,0,0,0.3)
    }
    .pin-marker::after{content:'';position:absolute;width:16px;height:16px;background:#fff;border-radius:50%;top:50%;left:50%;transform:translate(-50%,-50%)}
    .pin-number{
      position:absolute;top:-30px;left:50%;transform:translateX(-50%);
      color:#1e293b;font-weight:800;font-size:14px;background:#fff;padding:4px 10px;border-radius:8px;white-space:nowrap;
      transition:all .3s;box-shadow:0 4px 10px rgba(0,0,0,0.2)
    }
    .pin-marker.active{background:#ef4444 !important}
    .pin-marker.active + .pin-number{background:#ef4444 !important;color:#fff;top:-38px}
    @keyframes bounceAction{0%,100%{transform:translateY(0)}50%{transform:translateY(-15px)}}
    .bounce-anim{animation:bounceAction 1s infinite ease-in-out}

    .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large{background-color:rgba(37,99,235,0.8)!important}
    .marker-cluster div{background-color:rgba(37,99,235,0.95)!important;color:#fff!important;font-weight:800}
    .leaflet-container.crosshair-cursor-enabled{cursor:crosshair}
    .map-edit-active{border:4px solid #ef4444;box-sizing:border-box}
    .leaflet-marker-draggable{cursor:move !important}

    /* Alt panel */
    #bottomNavPanel{
      position:fixed;bottom:-320px;left:0;width:100%;
      background:rgba(30,41,59,0.95);backdrop-filter:blur(10px);z-index:2000;
      border-top-left-radius:24px;border-top-right-radius:24px;
      box-shadow:0 -10px 40px rgba(0,0,0,0.5);border-top:1px solid rgba(255,255,255,0.1);
      padding:25px;transition:bottom .4s cubic-bezier(0.175,0.885,0.32,1.275);
      display:flex;flex-direction:column;gap:12px;
    }
    #bottomNavPanel.active{bottom:0}
    .nav-info-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px}
    .nav-title{font-size:20px;font-weight:800;color:#fff}
    .nav-subtitle{font-size:14px;color:#94a3b8}
    .nav-distance{font-size:24px;font-weight:900;color:#3b82f6;text-shadow:0 0 20px rgba(59,130,246,0.5)}
    .btn-start-nav{
      background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);color:#fff;border:none;padding:16px;
      border-radius:14px;font-size:16px;font-weight:800;cursor:pointer;width:100%;
      display:flex;align-items:center;justify-content:center;gap:10px;box-shadow:0 4px 15px rgba(37,99,235,0.4)
    }
    .btn-stop-nav{background:#f59e0b;color:#fff;border:none;padding:16px;border-radius:14px;font-size:16px;font-weight:800;cursor:pointer;width:100%;display:none}
    .btn-delete-nav{
      background:rgba(239,68,68,0.2);color:#ef4444;border:1px solid rgba(239,68,68,0.3);padding:16px;
      border-radius:14px;font-size:16px;font-weight:800;cursor:pointer;width:100%;display:none
    }

    .user-location-marker{
      width:20px;height:20px;background:#3b82f6;border:3px solid #fff;border-radius:50%;
      box-shadow:0 0 0 10px rgba(59,130,246,0.3);animation:pulse 2s infinite;
    }
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(59,130,246,0.4)}70%{box-shadow:0 0 0 15px rgba(59,130,246,0)}100%{box-shadow:0 0 0 0 rgba(59,130,246,0)}}

    #versionTag{position:absolute;bottom:6px;left:8px;color:rgba(255,255,255,0.18);font-size:10px;z-index:9999}
  </style>
</head>

<body>

<div id="versionTag">v1.0 - Göldağ • Sinop OBM / Ayancık OİM</div>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-container">
    <div class="brand-name">MEHMET TALHA IŞIK</div>
    <div class="brand-title">GÖLDAĞ SAHA</div>
    <div class="brand-slogan">TÜRK MÜHENDİSLİĞİNİN DİJİTAL GÜCÜ</div>

    <button id="btnGuest" class="login-btn btn-guest">
      <svg viewBox="0 0 24 24"><path d="M12 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8zM6 18c0-2.66 5.33-4 8-4s8 1.34 8 4v2H6v-2z" fill-opacity="0.7"/></svg>
      Misafir Olarak Devam Et
    </button>

    <button id="btnUser" class="login-btn btn-user">
      <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
      Kullanıcı Girişi Yap
    </button>

    <button id="btnAdmin" class="login-btn btn-admin">
      <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 6c1.4 0 2.8 1.1 2.8 2.5V11c.6 0 1.2.6 1.2 1.2v3.5c0 .7-.6 1.3-1.2 1.3H9.2c-.6 0-1.2-.6-1.2-1.2v-3.5c0-.7.6-1.3 1.2-1.2V9.5C9.2 8.1 10.6 7 12 7zm0 1c-.8 0-1.5.7-1.5 1.5V11h3V9.5c0-.8-.7-1.5-1.5-1.5z"/></svg>
      Yönetici Girişi Yap
    </button>

    <div class="version-text">v1.0 — Göldağ</div>
  </div>
</div>

<!-- AUTH MODAL (basit şifre) -->
<div id="authModal">
  <div class="auth-box">
    <h2 id="authTitle" style="margin-bottom:20px;font-weight:800;">Giriş Yap</h2>
    <input type="text" id="authUsername" class="auth-input" placeholder="Kullanıcı Adı" autocapitalize="none">
    <input type="password" id="authPassword" class="auth-input" placeholder="Şifre">
    <div id="authError" class="error-msg">Hatalı kullanıcı adı veya şifre!</div>
    <div class="modal-buttons">
      <button id="btnAuthCancel" class="btn-cancel">İptal</button>
      <button id="btnAuthLogin" class="btn-save">Giriş</button>
    </div>
  </div>
</div>

<input type="text" id="searchInput" class="search-box" placeholder="Numara Ara..." autocomplete="off">

<button id="addMarkerBtn" class="action-btn" title="Yeni Ekle">
  <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
</button>

<button id="lockBtn" class="action-btn" title="Düzenleme Kilidi" style="display:none;">
  <svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
</button>

<button id="gpsBtn" class="action-btn" title="GPS (Takip / Navigasyon)" style="display:none;">
  <svg viewBox="0 0 24 24"><path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm8 3h-2.07A7.002 7.002 0 0 0 13 6.07V4h-2v2.07A7.002 7.002 0 0 0 6.07 11H4v2h2.07A7.002 7.002 0 0 0 11 17.93V20h2v-2.07A7.002 7.002 0 0 0 17.93 13H20v-2z"/></svg>
</button>

<button id="exportBtn" class="action-btn" title="CSV Dışa Aktar" style="display:none;">
  <svg viewBox="0 0 24 24"><path d="M5 20h14v-2H5v2zM12 2l-5.5 5.5 1.42 1.42L11 5.84V16h2V5.84l3.08 3.08 1.42-1.42L12 2z"/></svg>
</button>

<!-- NAV PANEL -->
<div id="bottomNavPanel">
  <div class="nav-info-row">
    <div>
      <div id="navTargetTitle" class="nav-title">İstif No: --</div>
      <div class="nav-subtitle">Seçili Hedef</div>
    </div>
    <div id="navDistance" class="nav-distance">-- m</div>
  </div>

  <button id="btnStartNav" class="btn-start-nav">
    <svg style="width:24px;height:24px;fill:white" viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
    Navigasyonu Başlat
  </button>
  <button id="btnStopNav" class="btn-stop-nav">Navigasyonu Bitir</button>
  <button id="btnPanelDelete" class="btn-delete-nav">Bu İstifi Sil</button>
</div>

<!-- ADD MODAL -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <h2 style="color:#3b82f6;margin-bottom:20px;font-weight:800;">İstif Numarası</h2>
    <input type="text" id="markerNumber" placeholder="Numara girin..." autocomplete="off">
    <div class="modal-buttons">
      <button class="btn-cancel" id="btnAddCancel">İptal</button>
      <button class="btn-save" id="btnAddSave">Kaydet</button>
    </div>
  </div>
</div>

<!-- DELETE MODAL -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <h2 style="color:#ef4444;margin-bottom:20px;font-weight:800;">İstif Sil</h2>
    <p style="margin-bottom:20px;color:rgba(255,255,255,0.7);">Bu istifi silmek istediğinize emin misiniz?</p>
    <div class="modal-buttons">
      <button class="btn-cancel" id="btnDeleteCancel">İptal</button>
      <button class="btn-delete" id="btnDeleteConfirm">Sil</button>
    </div>
  </div>
</div>

<div id="map"></div>

<script>
/* =============================
   GÖLDAĞ HARİTA (CRS.Simple + UTM metre)
   ============================= */
const MAP_IMG = "goldag_map_5000w.jpg";
const WEST  = 638000;
const EAST  = 657000;
const SOUTH = 4615000;
const NORTH = 4639000;

// Sabit offset (senin kalibrasyonun)
const OFFSET_DX = 202.06;
const OFFSET_DY = -338.16;

// proj4: WGS84 -> UTM 36N
const WGS84 = "EPSG:4326";
const UTM36 = "+proj=utm +zone=36 +datum=WGS84 +units=m +no_defs";

function applyOffset(E, N){ return { E: E + OFFSET_DX, N: N + OFFSET_DY }; }
function removeOffset(E_map, N_map){ return { E: E_map - OFFSET_DX, N: N_map - OFFSET_DY }; }

/* =============================
   LocalStorage veri
   ============================= */
const STORE_KEY = "goldag_points_v1";
function loadPoints(){
  try { return JSON.parse(localStorage.getItem(STORE_KEY) || "[]"); } catch { return []; }
}
function savePoints(arr){
  localStorage.setItem(STORE_KEY, JSON.stringify(arr));
}

/* =============================
   UI / Auth
   ============================= */
let userRole = null;
let targetRole = null;
let isEditMode = false;
let addingMarkerMode = false;
let tempLatLng = null;       // CRS.Simple latlng (N,E)
let markerToDeleteId = null;

let lastActiveMarker = null;
let navigationActive = false;
let watchId = null;
let userMarker = null;
let navPolyline = null;
let currentTargetLatLng = null;

document.getElementById('btnGuest').addEventListener('click', () => { userRole = 'guest'; initAppLayout(); });
document.getElementById('btnUser').addEventListener('click', () => openAuthModal('user'));
document.getElementById('btnAdmin').addEventListener('click', () => openAuthModal('admin'));
document.getElementById('btnAuthCancel').addEventListener('click', () => { document.getElementById('authModal').style.display = 'none'; });
document.getElementById('btnAuthLogin').addEventListener('click', attemptLogin);

function openAuthModal(role){
  targetRole = role;
  document.getElementById('authModal').style.display = 'flex';
  document.getElementById('authTitle').innerText = role === 'admin' ? 'Yönetici Girişi' : 'Kullanıcı Girişi';
  document.getElementById('authError').style.display = 'none';
  document.getElementById('authUsername').value = '';
  document.getElementById('authPassword').value = '';
  document.getElementById('authUsername').focus();
}

// Şifreler (istersen değiştir)
function attemptLogin(){
  const u = document.getElementById('authUsername').value.trim();
  const p = document.getElementById('authPassword').value.trim();
  if (targetRole === 'user' && u === 'depo' && p === '1234'){ userRole = 'user'; initAppLayout(); }
  else if (targetRole === 'admin' && u === 'admin' && p === '1940'){ userRole = 'admin'; initAppLayout(); }
  else { document.getElementById('authError').style.display = 'block'; }
}

function initAppLayout(){
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('authModal').style.display = 'none';
  document.getElementById('map').style.display = 'block';
  document.getElementById('searchInput').style.display = 'block';

  const addBtn = document.getElementById('addMarkerBtn');
  const lockBtn = document.getElementById('lockBtn');
  const gpsBtn  = document.getElementById('gpsBtn');
  const exportBtn = document.getElementById('exportBtn');

  if (userRole === 'guest'){
    addBtn.style.display = 'none';
    lockBtn.style.display = 'none';
    exportBtn.style.display = 'none';
  } else {
    addBtn.style.display = 'flex';
    lockBtn.style.display = 'flex';
    exportBtn.style.display = 'flex';
  }
  // GPS butonu herkeste olsun
  gpsBtn.style.display = 'flex';

  setTimeout(() => { map.invalidateSize(); map.fitBounds(bounds); }, 250);
}

/* =============================
   Leaflet Map (CRS.Simple)
   ============================= */
const bounds = L.latLngBounds(L.latLng(SOUTH, WEST), L.latLng(NORTH, EAST));

const map = L.map('map', {
  crs: L.CRS.Simple,
  center: bounds.getCenter(),
  zoom: 0,
  minZoom: -4,
  maxZoom: 4,
  zoomSnap: 0.25,
  zoomDelta: 0.25,
  zoomControl: false
});

L.control.zoom({ position: 'bottomright' }).addTo(map);

L.imageOverlay(MAP_IMG, bounds).addTo(map);
map.fitBounds(bounds);
map.setMaxBounds(bounds);
map.on("drag", () => map.panInsideBounds(bounds, { animate:false }));

/* Cluster */
const markersCluster = L.markerClusterGroup({
  disableClusteringAtZoom: 2.5,
  spiderfyOnMaxZoom: true,
  showCoverageOnHover: false
});
map.addLayer(markersCluster);

const markers = {}; // id -> marker

function createNumberIcon(num){
  return L.divIcon({
    className: "custom-div-icon",
    html: `<div class="pin-wrapper"><div class="pin-marker" data-pin="${num}"></div><div class="pin-number">${num}</div></div>`,
    iconSize: [50, 60],
    iconAnchor: [25, 60]
  });
}

/* =============================
   Marker CRUD (local)
   ============================= */
function addPointLocal(title, latlng){
  const id = "p_" + Date.now() + "_" + Math.random().toString(16).slice(2);
  const arr = loadPoints();
  arr.push({ id, title, lat: latlng.lat, lng: latlng.lng, createdAt: Date.now() });
  savePoints(arr);
  renderPoint({ id, title, lat: latlng.lat, lng: latlng.lng });
}

function updatePointLocal(id, latlng){
  const arr = loadPoints();
  const i = arr.findIndex(x => x.id === id);
  if(i >= 0){
    arr[i].lat = latlng.lat;
    arr[i].lng = latlng.lng;
    savePoints(arr);
  }
}

function deletePointLocal(id){
  const arr = loadPoints().filter(x => x.id !== id);
  savePoints(arr);
}

function renderAll(){
  markersCluster.clearLayers();
  for(const k in markers) delete markers[k];
  const arr = loadPoints();
  arr.forEach(p => renderPoint(p));
}

function setActiveMarker(marker){
  if(lastActiveMarker){
    const el = lastActiveMarker.getElement();
    if(el){
      el.querySelector('.pin-marker')?.classList.remove('active');
      el.querySelector('.pin-wrapper')?.classList.remove('bounce-anim');
    }
  }
  const el = marker.getElement();
  if(el){
    el.querySelector('.pin-marker')?.classList.add('active');
    el.querySelector('.pin-wrapper')?.classList.add('bounce-anim');
  }
  lastActiveMarker = marker;
}

function renderPoint(p){
  const m = L.marker([p.lat, p.lng], {
    icon: createNumberIcon(p.title || "?"),
    draggable: isEditMode
  });

  m.myTitle = p.title;
  m.localId = p.id;

  m.on('dragend', () => {
    const newPos = m.getLatLng();
    updatePointLocal(p.id, newPos);
  });

  m.on('click', (e) => {
    L.DomEvent.stopPropagation(e);

    setActiveMarker(m);
    map.setView(m.getLatLng(), map.getZoom());

    document.getElementById('navTargetTitle').innerText = "İstif No: " + (p.title || "--");
    document.getElementById('navDistance').innerText = "-- m";
    document.getElementById('bottomNavPanel').classList.add('active');

    currentTargetLatLng = m.getLatLng();

    if(navigationActive){
      document.getElementById('btnStartNav').style.display = 'none';
      document.getElementById('btnStopNav').style.display = 'block';
    } else {
      document.getElementById('btnStartNav').style.display = 'flex';
      document.getElementById('btnStopNav').style.display = 'none';
    }

    const delBtn = document.getElementById('btnPanelDelete');
    if(isEditMode){
      delBtn.style.display = 'block';
      delBtn.onclick = () => openDelete(p.id);
    } else {
      delBtn.style.display = 'none';
    }
  });

  markers[p.id] = m;
  markersCluster.addLayer(m);
}

function openDelete(id){
  markerToDeleteId = id;
  document.getElementById("deleteModal").classList.add("show");
}

/* =============================
   Map click behavior
   ============================= */
map.on('click', (e) => {
  if(!addingMarkerMode && !navigationActive){
    document.getElementById('bottomNavPanel').classList.remove('active');
    if(lastActiveMarker){
      const el = lastActiveMarker.getElement();
      if(el){
        el.querySelector('.pin-marker')?.classList.remove('active');
        el.querySelector('.pin-wrapper')?.classList.remove('bounce-anim');
      }
      lastActiveMarker = null;
    }
  }

  if(addingMarkerMode){
    tempLatLng = e.latlng;
    document.getElementById("addModal").classList.add("show");
    document.getElementById("markerNumber").value = "";
    document.getElementById("markerNumber").focus();
  }
});

/* =============================
   Buttons
   ============================= */
const addMarkerBtn = document.getElementById("addMarkerBtn");

addMarkerBtn.addEventListener("click", () => {
  addingMarkerMode = !addingMarkerMode;
  if(addingMarkerMode){
    addMarkerBtn.classList.add("active");
    addMarkerBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>';
    map.getContainer().classList.add("crosshair-cursor-enabled");
    document.getElementById('bottomNavPanel').classList.remove('active');
  } else {
    addMarkerBtn.classList.remove("active");
    addMarkerBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>';
    map.getContainer().classList.remove("crosshair-cursor-enabled");
  }
});

document.getElementById("btnAddSave").addEventListener("click", () => {
  const val = document.getElementById("markerNumber").value.trim();
  if(val && tempLatLng){
    addPointLocal(val, tempLatLng);
    document.getElementById("addModal").classList.remove("show");
    tempLatLng = null;
    addingMarkerMode = false;
    addMarkerBtn.classList.remove("active");
    addMarkerBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>';
    map.getContainer().classList.remove("crosshair-cursor-enabled");
  }
});
document.getElementById("btnAddCancel").addEventListener("click", () => {
  document.getElementById("addModal").classList.remove("show");
  tempLatLng = null;
});

document.getElementById("btnDeleteConfirm").addEventListener("click", () => {
  if(markerToDeleteId){
    // remove marker from map
    const m = markers[markerToDeleteId];
    if(m){ markersCluster.removeLayer(m); delete markers[markerToDeleteId]; }
    deletePointLocal(markerToDeleteId);
    markerToDeleteId = null;
    document.getElementById("deleteModal").classList.remove("show");
    document.getElementById('bottomNavPanel').classList.remove('active');
  }
});
document.getElementById("btnDeleteCancel").addEventListener("click", () => {
  document.getElementById("deleteModal").classList.remove("show");
  markerToDeleteId = null;
});

document.getElementById('lockBtn').addEventListener('click', () => {
  isEditMode = !isEditMode;
  const btn = document.getElementById('lockBtn');
  btn.classList.toggle('unlocked', isEditMode);
  document.getElementById('map').classList.toggle('map-edit-active', isEditMode);

  btn.innerHTML = isEditMode
    ? '<svg viewBox="0 0 24 24"><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z"/></svg>'
    : '<svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>';

  // enable/disable dragging
  for(const id in markers){
    const m = markers[id];
    if(isEditMode) m.dragging.enable(); else m.dragging.disable();
  }

  // panel delete visibility
  const delBtn = document.getElementById('btnPanelDelete');
  delBtn.style.display = isEditMode ? 'block' : 'none';
});

document.getElementById("searchInput").addEventListener("input", (e) => {
  const val = e.target.value.trim();
  if(val === "") return;
  for(const id in markers){
    if(markers[id].myTitle == val){
      markersCluster.zoomToShowLayer(markers[id], () => markers[id].fire('click'));
      break;
    }
  }
});

/* =============================
   Navigation (GPS -> UTM36 -> offset -> map coords)
   ============================= */
function updateUserLocation(position){
  const lat = position.coords.latitude;
  const lon = position.coords.longitude;

  // Convert to UTM true
  const [E0, N0] = proj4(WGS84, UTM36, [lon, lat]);

  // Apply offset to map coords
  const p = applyOffset(E0, N0);
  const userLatLng = L.latLng(p.N, p.E);

  if(!userMarker){
    const userIcon = L.divIcon({ className: 'user-location-marker', iconSize:[20,20], iconAnchor:[10,10] });
    userMarker = L.marker(userLatLng, { icon: userIcon }).addTo(map);
  } else {
    userMarker.setLatLng(userLatLng);
  }

  if(navigationActive && currentTargetLatLng){
    // Euclidean distance in meters (map coords are meters)
    const dx = (userLatLng.lng - currentTargetLatLng.lng);
    const dy = (userLatLng.lat - currentTargetLatLng.lat);
    const distance = Math.sqrt(dx*dx + dy*dy);

    document.getElementById('navDistance').innerText = Math.round(distance) + " m";

    if(navPolyline){
      navPolyline.setLatLngs([userLatLng, currentTargetLatLng]);
    } else {
      navPolyline = L.polyline([userLatLng, currentTargetLatLng], {
        color:'#3b82f6', weight:4, opacity:0.9, dashArray:'10,10'
      }).addTo(map);
    }
  }
}

function locationError(err){
  console.warn("GPS Hatası:", err.code, err.message);
}

document.getElementById('btnStartNav').addEventListener('click', () => {
  if(!currentTargetLatLng) return;

  if(navigator.geolocation){
    navigationActive = true;
    document.getElementById('btnStartNav').style.display = 'none';
    document.getElementById('btnStopNav').style.display = 'block';

    if(navPolyline){ map.removeLayer(navPolyline); navPolyline = null; }

    watchId = navigator.geolocation.watchPosition(updateUserLocation, locationError, {
      enableHighAccuracy:true, maximumAge:1000, timeout:10000
    });
  } else {
    alert("Tarayıcınız konum servisini desteklemiyor.");
  }
});

document.getElementById('btnStopNav').addEventListener('click', stopNavigation);

function stopNavigation(){
  navigationActive = false;
  if(watchId) navigator.geolocation.clearWatch(watchId);
  watchId = null;

  if(navPolyline){ map.removeLayer(navPolyline); navPolyline = null; }
  if(userMarker){ map.removeLayer(userMarker); userMarker = null; }

  document.getElementById('btnStartNav').style.display = 'flex';
  document.getElementById('btnStopNav').style.display = 'none';
  document.getElementById('navDistance').innerText = "-- m";

  if(lastActiveMarker){
    const el = lastActiveMarker.getElement();
    if(el){
      el.querySelector('.pin-marker')?.classList.remove('active');
      el.querySelector('.pin-wrapper')?.classList.remove('bounce-anim');
    }
    lastActiveMarker = null;
  }
  document.getElementById('bottomNavPanel').classList.remove('active');
  currentTargetLatLng = null;
}

// GPS butonu: haritayı konuma getir + (aktifse) navigasyon mesafesi güncellenir
document.getElementById('gpsBtn').addEventListener('click', () => {
  if(!navigator.geolocation) return alert("GPS desteklenmiyor.");
  navigator.geolocation.getCurrentPosition(pos => {
    const [E0, N0] = proj4(WGS84, UTM36, [pos.coords.longitude, pos.coords.latitude]);
    const p = applyOffset(E0, N0);
    const ll = L.latLng(p.N, p.E);
    map.setView(ll, 1.5);

    // user marker tek seferlik göster
    updateUserLocation(pos);
  }, () => alert("GPS konumu alınamadı."), { enableHighAccuracy:true, timeout:12000, maximumAge:0 });
});

/* =============================
   Export CSV (title, mapE, mapN, trueE, trueN)
   ============================= */
document.getElementById('exportBtn').addEventListener('click', () => {
  const arr = loadPoints();
  let csv = "ID;No;Map_E;Map_N;UTM_E;UTM_N\n";
  arr.forEach(p => {
    const rev = removeOffset(p.lng, p.lat); // map lng=E, map lat=N
    csv += `${p.id};${p.title};${p.lng};${p.lat};${rev.E};${rev.N}\n`;
  });

  const blob = new Blob([csv], { type:'text/csv' });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `Goldag_Data.csv`;
  link.click();
});

/* İlk çizim */
renderAll();
</script>
</body>
</html>
