<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Saha Navigasyon – Göldağ</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Proj4 (WGS84 <-> UTM) -->
  <script src="https://unpkg.com/proj4@2.9.2/dist/proj4.js"></script>

  <style>
    body{margin:0;font-family:Arial;background:#0b1220;color:#e9eefc}
    header{padding:16px;background:#0e1730;border-bottom:1px solid #1c2a4a}
    h1{margin:0;font-size:20px}
    .wrap{max-width:1200px;margin:auto;padding:16px}
    .card{background:#111c3a;border:1px solid #1c2a4a;border-radius:14px;padding:16px;margin-bottom:16px}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    input,button{
      width:100%;padding:10px;border-radius:8px;
      border:1px solid #2b3c66;background:#0b1220;color:#fff
    }
    button{background:#1f3bff;font-weight:bold;cursor:pointer}
    button.secondary{background:#23304e}
    #map{height:680px;border-radius:14px;border:1px solid #1c2a4a}
    .info{font-size:12px;opacity:.8;margin-top:8px;line-height:1.4}
  </style>
</head>

<body>
<header>
  <h1>SAHA NAVİGASYON – Göldağ</h1>
</header>

<div class="wrap">

  <div class="card">
    <h2>İşaretleme</h2>

    <div class="row">
      <input id="label" placeholder="Etiket / İstif (örn: GACAK-153)">
      <input id="easting" placeholder="UTM Easting (E)">
      <input id="northing" placeholder="UTM Northing (N)">
    </div>

    <button onclick="markUTM()">UTM ile İşaretle</button>
    <button class="secondary" onclick="markGPS()" style="margin-top:8px">
      GPS ile İşaretle
    </button>

    <div class="info">
      <b>Kalibrasyon sabitlendi.</b><br>
      Referans nokta: <b>GACAK-153 → E 642595 / N 4634899</b><br>
      Sabit offset: <b>DX = 202.06 m</b>, <b>DY = -338.16 m</b>
    </div>
  </div>

  <div class="card">
    <h2>Harita</h2>
    <div id="map"></div>
  </div>

</div>

<script>
/* =============================
   HARİTA SINIRLARI (UTM 36N)
   ============================= */
const WEST  = 638000;
const EAST  = 657000;
const SOUTH = 4615000;
const NORTH = 4639000;

/* =============================
   PROJEKSİYON TANIMLARI
   ============================= */
const WGS84 = "EPSG:4326";
const UTM36 = "+proj=utm +zone=36 +datum=WGS84 +units=m +no_defs";

/* =============================
   SABİT KALİBRASYON OFFSET
   ============================= */
const OFFSET_DX = 202.06;   // Easting düzeltmesi (m)
const OFFSET_DY = -338.16;  // Northing düzeltmesi (m)

function applyOffset(E, N){
  return { E: E + OFFSET_DX, N: N + OFFSET_DY };
}

/* =============================
   HARİTA OLUŞTUR
   ============================= */
const map = L.map("map", {
  crs: L.CRS.Simple,
  minZoom: -4,
  maxZoom: 4,
  zoomSnap: 0.25,
  zoomDelta: 0.25
});

const bounds = [[SOUTH, WEST], [NORTH, EAST]];

L.imageOverlay("goldag_map_5000w.jpg", bounds).addTo(map);
map.fitBounds(bounds, { padding:[60,60] });
map.setMaxBounds(bounds);
map.on("drag", () => map.panInsideBounds(bounds, { animate:false }));

const layer = L.layerGroup().addTo(map);

/* =============================
   UTM İLE İŞARETLE
   ============================= */
function markUTM(){
  layer.clearLayers();

  const E0 = parseFloat(document.getElementById("easting").value);
  const N0 = parseFloat(document.getElementById("northing").value);
  if(Number.isNaN(E0) || Number.isNaN(N0)){
    alert("UTM koordinatları giriniz (E ve N).");
    return;
  }

  const t = (document.getElementById("label").value || "Nokta").trim();
  const p = applyOffset(E0, N0);

  L.marker([p.N, p.E]).addTo(layer)
    .bindPopup(`${t}<br>E:${E0.toFixed(2)}<br>N:${N0.toFixed(2)}<br>DX:${OFFSET_DX} DY:${OFFSET_DY}`)
    .openPopup();

  map.setView([p.N, p.E], 1);
}

/* =============================
   GPS İLE İŞARETLE
   ============================= */
function markGPS(){
  if(!navigator.geolocation){
    alert("Bu cihazda GPS (geolocation) desteklenmiyor.");
    return;
  }

  navigator.geolocation.getCurrentPosition(pos=>{
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    const [E0, N0] = proj4(WGS84, UTM36, [lon, lat]);
    const p = applyOffset(E0, N0);

    document.getElementById("easting").value = E0.toFixed(2);
    document.getElementById("northing").value = N0.toFixed(2);

    layer.clearLayers();
    const t = (document.getElementById("label").value || "GPS").trim();
    L.marker([p.N, p.E]).addTo(layer).bindPopup(`${t}<br>Lat:${lat.toFixed(6)} Lon:${lon.toFixed(6)}`).openPopup();
    map.setView([p.N, p.E], 1);
  }, ()=>{
    alert("GPS konumu alınamadı. (İzin ver / konumu aç)");
  }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
}

/* Haritaya tıklayınca tıklanan koordinatı inputlara yaz */
map.on("click", (ev)=>{
  document.getElementById("northing").value = ev.latlng.lat.toFixed(2);
  document.getElementById("easting").value  = ev.latlng.lng.toFixed(2);
});
</script>

</body>
</html>
