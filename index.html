<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Saha Navigasyon – Göldağ</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />

  <!-- Font -->
  <link href="https://api.fontshare.com/v2/css?f[]=satoshi@900,700,500,400&display=swap" rel="stylesheet">

  <!-- Proj4 -->
  <script src="https://unpkg.com/proj4@2.9.2/dist/proj4.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { height:100%; overflow:hidden; background:#0b1220; font-family:'Satoshi', sans-serif; }
    #map { height:100%; width:100%; background:#0f172a; display:none; }

    /* ---- GİRİŞ ---- */
    #loginScreen{
      position:fixed; inset:0; z-index:5000;
      display:flex; align-items:center; justify-content:center; padding:18px;
      background: radial-gradient(circle at 50% 0%, #243356 0%, #0b1220 55%, #050812 100%);
    }
    .login-container{
      width:100%; max-width:420px; text-align:center;
      background: rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.10);
      border-top:1px solid rgba(255,255,255,0.20);
      border-radius:22px;
      padding:38px 30px;
      backdrop-filter: blur(18px);
      box-shadow: 0 25px 60px rgba(0,0,0,0.55);
      animation: fadeIn .7s ease-out;
    }
    @keyframes fadeIn { from {opacity:0; transform: translateY(16px);} to {opacity:1; transform: translateY(0);} }

    .brand-name{
      font-size:26px; font-weight:900; color:#fff; letter-spacing:-.5px;
      text-shadow: 0 2px 12px rgba(0,0,0,0.35);
      margin-bottom:6px;
    }
    .brand-title{
      font-size:12px; font-weight:700; color: rgba(255,255,255,.65);
      letter-spacing: 1.2px; text-transform: uppercase;
      margin-bottom:18px;
    }
    .brand-slogan{
      display:inline-block;
      font-size:11px; font-weight:900;
      color:#22c55e; letter-spacing:1.4px; text-transform: uppercase;
      margin-bottom:28px;
      opacity:.95;
    }
    .brand-slogan::after{
      content:''; display:block; width:46px; height:2px; margin:10px auto 0;
      background: rgba(34,197,94,0.35); border-radius:2px;
    }

    .login-btn{
      width:100%;
      display:flex; align-items:center; justify-content:center; gap:12px;
      padding:15px; border:none; border-radius:14px;
      cursor:pointer; font-size:15px; font-weight:800;
      transition: all .25s ease;
      margin-bottom:12px;
    }
    .login-btn svg{ width:20px; height:20px; fill: currentColor; }
    .btn-guest{ background: rgba(255,255,255,0.10); color: rgba(255,255,255,0.92); border:1px solid rgba(255,255,255,0.05); }
    .btn-guest:hover{ background: rgba(255,255,255,0.18); transform: translateY(-2px); }
    .btn-user{ background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color:#fff; box-shadow: 0 8px 26px rgba(37,99,235,0.45); }
    .btn-user:hover{ box-shadow: 0 12px 32px rgba(37,99,235,0.65); transform: translateY(-2px); }
    .btn-admin{ background: rgba(0,0,0,0.55); color: rgba(255,255,255,0.85); border:1px solid rgba(255,255,255,0.06); }
    .btn-admin:hover{ background: rgba(0,0,0,0.85); color:#fff; border-color: rgba(255,255,255,0.18); transform: translateY(-2px); }

    .version-text{
      margin-top:10px;
      font-size:11px; color: rgba(255,255,255,0.30);
      font-weight:600; letter-spacing:.6px;
    }

    /* ---- MODAL ---- */
    #authModal, .modal{
      display:none; position:fixed; inset:0; z-index:6000;
      background: rgba(0,0,0,0.70);
      backdrop-filter: blur(6px);
      align-items:center; justify-content:center;
      padding:18px;
    }
    .modal.show, #authModal.show{ display:flex; }
    .auth-box, .modal-content{
      width:100%; max-width:360px;
      background:#111c3a; color:#fff;
      border:1px solid rgba(255,255,255,0.10);
      border-radius:20px;
      padding:26px;
      box-shadow: 0 20px 70px rgba(0,0,0,0.55);
    }
    .auth-input, .modal-content input{
      width:100%;
      padding:14px;
      margin-bottom:14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.28);
      color:#fff;
      outline:none;
      font-size:15px;
      font-family:'Satoshi', sans-serif;
      transition: .2s;
    }
    .auth-input:focus{ border-color:#3b82f6; background: rgba(0,0,0,0.40); }
    .error-msg{ color:#ff5a5a; font-weight:800; display:none; margin-bottom:10px; text-align:center; }
    .modal-buttons{ display:flex; gap:10px; }
    .btn-save{ flex:1; padding:12px; border-radius:12px; border:none; cursor:pointer; font-weight:900; background:#2563eb; color:#fff; }
    .btn-cancel{ flex:1; padding:12px; border-radius:12px; border:none; cursor:pointer; font-weight:900; background: rgba(255,255,255,0.10); color:#fff; }
    .btn-delete{ flex:1; padding:12px; border-radius:12px; border:none; cursor:pointer; font-weight:900; background:#ef4444; color:#fff; }

    /* ---- ÜST ARAMA ---- */
    .search-box{
      position:absolute; top:16px; left:50%; transform: translateX(-50%);
      width:240px; z-index:1200;
      padding:12px 18px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(17,28,58,0.90);
      color:#fff;
      text-align:center;
      box-shadow: 0 14px 32px rgba(0,0,0,0.35);
      display:none;
      outline:none;
      font-weight:700;
    }

    /* ---- SAĞ BUTONLAR ---- */
    .action-btn{
      position:absolute; right:16px;
      width:52px; height:52px; border-radius:16px;
      border:none; cursor:pointer; z-index:1200;
      display:none; align-items:center; justify-content:center;
      box-shadow: 0 14px 28px rgba(0,0,0,0.42);
      color:#fff;
      transition: all .2s ease;
    }
    .action-btn svg{ width:24px; height:24px; fill: currentColor; pointer-events:none; }
    #addMarkerBtn{ top:16px; background:#2563eb; }
    #addMarkerBtn.active{ background:#ef4444; }
    #lockBtn{ top:78px; background:#475569; }
    #lockBtn.unlocked{ background:#ef4444; }
    #exportBtn{ top:140px; background:#16a34a; }

    /* ---- Marker UI ---- */
    .custom-div-icon{ background:transparent; border:none; }
    .pin-wrapper{ position:relative; width:50px; height:60px; pointer-events:none; }
    .pin-marker{
      position:absolute; width:36px; height:36px;
      background:#2563eb;
      border-radius:50% 50% 50% 0;
      left:7px; top:0;
      border:3px solid #fff;
      transform: rotate(-45deg);
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      pointer-events:auto;
      transition: background .2s;
    }
    .pin-marker::after{
      content:''; position:absolute; width:16px; height:16px;
      background:#fff; border-radius:50%;
      top:50%; left:50%; transform: translate(-50%,-50%);
    }
    .pin-number{
      position:absolute; top:-30px; left:50%; transform: translateX(-50%);
      background:#fff; color:#0b1220;
      font-weight:900; font-size:13px;
      padding:4px 10px; border-radius:10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.20);
      white-space:nowrap;
      transition: all .2s;
      pointer-events:none;
    }
    .pin-marker.active{ background:#ef4444 !important; }
    .pin-marker.active + .pin-number{ background:#ef4444 !important; color:#fff; top:-36px; }

    @keyframes bounce { 0%,100% {transform: translateY(0);} 50% {transform: translateY(-12px);} }
    .bounce-anim{ animation: bounce 1s infinite ease-in-out; }

    .leaflet-container.crosshair-cursor-enabled{ cursor: crosshair; }
    .map-edit-active{ outline: 4px solid #ef4444; outline-offset: -4px; }

    /* ---- Alt panel (navigasyon) ---- */
    #bottomNavPanel{
      position:fixed; left:0; right:0; bottom:-340px; z-index:2000;
      padding:22px 20px;
      background: rgba(17,28,58,0.95);
      backdrop-filter: blur(10px);
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      border-top: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 -14px 50px rgba(0,0,0,0.55);
      transition: bottom .35s cubic-bezier(0.175, 0.885, 0.32, 1.2);
      display:flex; flex-direction:column; gap:12px;
    }
    #bottomNavPanel.active{ bottom:0; }
    .nav-info-row{ display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .nav-title{ font-size:18px; font-weight:900; color:#fff; }
    .nav-subtitle{ font-size:13px; color: rgba(255,255,255,0.55); font-weight:700; margin-top:2px; }
    .nav-distance{ font-size:24px; font-weight:900; color:#3b82f6; text-shadow: 0 0 20px rgba(59,130,246,0.45); }

    .btn-start-nav{
      width:100%;
      display:flex; align-items:center; justify-content:center; gap:10px;
      padding:14px;
      border:none; border-radius:14px;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color:#fff; font-weight:900; cursor:pointer;
      box-shadow: 0 10px 22px rgba(37,99,235,0.35);
    }
    .btn-stop-nav{
      width:100%;
      padding:14px;
      border:none; border-radius:14px;
      background:#f59e0b; color:#fff; font-weight:900; cursor:pointer;
      display:none;
    }
    .btn-delete-nav{
      width:100%;
      padding:14px;
      border-radius:14px;
      border:1px solid rgba(239,68,68,0.30);
      background: rgba(239,68,68,0.14);
      color:#ef4444;
      font-weight:900; cursor:pointer;
      display:none;
    }

    .user-location-marker{
      width:20px; height:20px; border-radius:50%;
      background:#3b82f6;
      border:3px solid #fff;
      box-shadow: 0 0 0 10px rgba(59,130,246,0.25);
      animation: pulse 2s infinite;
    }
    @keyframes pulse{
      0%{ box-shadow:0 0 0 0 rgba(59,130,246,0.35); }
      70%{ box-shadow:0 0 0 15px rgba(59,130,246,0.0); }
      100%{ box-shadow:0 0 0 0 rgba(59,130,246,0.0); }
    }

    #versionTag{
      position:absolute; left:8px; bottom:6px; z-index:9999;
      font-size:10px; color: rgba(255,255,255,0.18); font-weight:700; letter-spacing:.4px;
      user-select:none;
    }
  </style>
</head>

<body>

<div id="versionTag">v1.0 — Göldağ</div>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-container">
    <div class="brand-name">SAHA NAVİGASYON</div>
    <div class="brand-title">GÖLDAĞ ORMAN İŞLETME ŞEFLİĞİ</div>
    <div class="brand-slogan">Kurumsal • Hızlı • Ortak Kayıt</div>

    <button id="btnGuest" class="login-btn btn-guest">
      <svg viewBox="0 0 24 24"><path d="M12 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8zM6 18c0-2.66 5.33-4 8-4s8 1.34 8 4v2H6v-2z" fill-opacity="0.8"/></svg>
      Misafir (Sadece Görüntüle)
    </button>

    <button id="btnUser" class="login-btn btn-user">
      <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
      Kullanıcı Girişi (Ekle)
    </button>

    <button id="btnAdmin" class="login-btn btn-admin">
      <svg viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 6c1.4 0 2.8 1.1 2.8 2.5V11c.6 0 1.2.6 1.2 1.2v3.5c0 .7-.6 1.3-1.2 1.3H9.2c-.6 0-1.2-.6-1.2-1.2v-3.5c0-.7.6-1.3 1.2-1.2V9.5C9.2 8.1 10.6 7 12 7zm0 1c-.8 0-1.5.7-1.5 1.5V11h3V9.5c0-.8-.7-1.5-1.5-1.5z"/></svg>
      Yönetici (Düzenle/Sil)
    </button>

    <div class="version-text">Göldağ — ortak istif işaretleme sistemi</div>
  </div>
</div>

<!-- AUTH MODAL -->
<div id="authModal">
  <div class="auth-box">
    <h2 id="authTitle" style="margin-bottom:16px; font-weight:900;">Giriş</h2>
    <input type="text" id="authUsername" class="auth-input" placeholder="Kullanıcı Adı" autocapitalize="none">
    <input type="password" id="authPassword" class="auth-input" placeholder="Şifre">
    <div id="authError" class="error-msg">Hatalı kullanıcı adı veya şifre!</div>
    <div class="modal-buttons">
      <button id="btnAuthCancel" class="btn-cancel">İptal</button>
      <button id="btnAuthLogin" class="btn-save">Giriş</button>
    </div>
    <div style="margin-top:12px; font-size:12px; color:rgba(255,255,255,0.45); font-weight:700;">
      Kullanıcı (örnek): <b>depo / 1234</b> • Admin (örnek): <b>admin / 1940</b>
    </div>
  </div>
</div>

<!-- UI -->
<input id="searchInput" class="search-box" placeholder="İstif No Ara... (örn: 153)" inputmode="numeric" pattern="[0-9]*">

<button id="addMarkerBtn" class="action-btn" title="Yeni Ekle">
  <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
</button>

<button id="lockBtn" class="action-btn" title="Düzenleme Kilidi">
  <svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
</button>

<button id="exportBtn" class="action-btn" title="CSV Aktar">
  <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9v-3H8v3H6V8h2v2h1V8h2v8zm5-1.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zm-3-3v1.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V11c0-1.66-1.34-3-3-3s-3 1.34-3 3v3h1.5v-3c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5v1.5c0 .83-.67 1.5-1.5 1.5s-1.5-.67-1.5-1.5V11h1.5v2.5z"/></svg>
</button>

<!-- Add marker modal -->
<div id="addModal" class="modal">
  <div class="modal-content">
    <h2 style="color:#3b82f6; margin-bottom:16px; font-weight:900;">İstif Etiketi</h2>
    <input type="text" id="markerNumber" placeholder="Örn: 153 veya GACAK-153" autocomplete="off">
    <div style="font-size:12px; color: rgba(255,255,255,0.55); font-weight:700; margin:-6px 0 14px;">
      Haritaya tıkladığın nokta kaydedilecek (UTM). İstersen GPS ile de ekle.
    </div>
    <div class="modal-buttons">
      <button class="btn-cancel" id="btnAddCancel">İptal</button>
      <button class="btn-save" id="btnAddSave">Kaydet</button>
    </div>
  </div>
</div>

<!-- Delete modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <h2 style="color:#ef4444; margin-bottom:14px; font-weight:900;">İstif Sil</h2>
    <p style="margin-bottom:16px; color: rgba(255,255,255,0.70); font-weight:700;">
      Bu istifi silmek istediğine emin misin?
    </p>
    <div class="modal-buttons">
      <button class="btn-cancel" id="btnDeleteCancel">İptal</button>
      <button class="btn-delete" id="btnDeleteConfirm">Sil</button>
    </div>
  </div>
</div>

<!-- Bottom nav panel -->
<div id="bottomNavPanel">
  <div class="nav-info-row">
    <div>
      <div id="navTargetTitle" class="nav-title">İstif: --</div>
      <div class="nav-subtitle">Seçili hedef</div>
    </div>
    <div id="navDistance" class="nav-distance">-- m</div>
  </div>

  <button id="btnStartNav" class="btn-start-nav">
    <svg style="width:24px;height:24px;fill:white" viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
    İstife Git (Başlat)
  </button>

  <button id="btnStopNav" class="btn-stop-nav">Navigasyonu Bitir</button>
  <button id="btnPanelDelete" class="btn-delete-nav">Bu İstifi Sil</button>
</div>

<div id="map"></div>

<!-- Leaflet + Cluster -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved, remove, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  /* =========================
     1) GOLDAG HARİTA AYARLARI
     ========================= */
  // Harita sınırları (UTM 36N metre)
  const WEST  = 638000;
  const EAST  = 657000;
  const SOUTH = 4615000;
  const NORTH = 4639000;

  // Harita görseli dosya adı (repo içinde)
  const MAP_IMAGE = "goldag_map_5000w.jpg";

  /* =========================
     2) SABİT OFFSET (KALİBRASYON)
     ========================= */
  // Sen “pin yerine oturdu” dediğin son offset değerleri:
  const OFFSET_DX = 202.06;   // Easting düzeltme (m)
  const OFFSET_DY = -338.16;  // Northing düzeltme (m)

  function applyOffset(E, N){
    return { E: E + OFFSET_DX, N: N + OFFSET_DY };
  }

  /* =========================
     3) GPS->UTM DÖNÜŞÜM (WGS84 -> UTM36N)
     ========================= */
  const WGS84 = "EPSG:4326";
  const UTM36 = "+proj=utm +zone=36 +datum=WGS84 +units=m +no_defs";

  function gpsToUtm(lon, lat){
    const [E, N] = proj4(WGS84, UTM36, [lon, lat]);
    return { E, N };
  }

  /* =========================
     4) FIREBASE (SENİN CONFIG)
     ========================= */
  const firebaseConfig = {
    apiKey: "AIzaSyBm3l2vIb_0cK_EFsIlwqLrI_GQvqyaoAM",
    authDomain: "goldag-saha.firebaseapp.com",
    databaseURL: "https://goldag-saha-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "goldag-saha",
    storageBucket: "goldag-saha.firebasestorage.app",
    messagingSenderId: "756903954012",
    appId: "1:756903954012:web:4b1fe1aa15d74c7f5d4899"
  };

  let app, db, pointsRef;
  try{
    app = initializeApp(firebaseConfig);
    db = getDatabase(app);
    pointsRef = ref(db, "goldag_saha"); // ✅ Tek saha: GÖLDAĞ
  }catch(e){
    alert("Firebase Hatası: " + e.message);
  }

  /* =========================
     5) ROL / UI DURUMLARI
     ========================= */
  let userRole = null;     // guest | user | admin
  let targetRole = null;
  let isEditMode = false;

  // login buttons
  const loginScreen = document.getElementById("loginScreen");
  const authModal = document.getElementById("authModal");
  const authTitle = document.getElementById("authTitle");
  const authError = document.getElementById("authError");
  const authUsername = document.getElementById("authUsername");
  const authPassword = document.getElementById("authPassword");

  document.getElementById("btnGuest").addEventListener("click", ()=>{
    userRole = "guest";
    initAppLayout();
  });

  document.getElementById("btnUser").addEventListener("click", ()=> openAuthModal("user"));
  document.getElementById("btnAdmin").addEventListener("click", ()=> openAuthModal("admin"));
  document.getElementById("btnAuthCancel").addEventListener("click", ()=> authModal.classList.remove("show"));
  document.getElementById("btnAuthLogin").addEventListener("click", attemptLogin);

  function openAuthModal(role){
    targetRole = role;
    authModal.classList.add("show");
    authTitle.innerText = role === "admin" ? "Yönetici Girişi" : "Kullanıcı Girişi";
    authError.style.display = "none";
    authUsername.value = "";
    authPassword.value = "";
    authUsername.focus();
  }

  // Şifreler (istersen sonra değiştiririz)
  function attemptLogin(){
    const u = authUsername.value.trim();
    const p = authPassword.value.trim();

    if(targetRole === "user" && u === "depo" && p === "1234"){
      userRole = "user"; initAppLayout();
    }else if(targetRole === "admin" && u === "admin" && p === "1940"){
      userRole = "admin"; initAppLayout();
    }else{
      authError.style.display = "block";
    }
  }

  function initAppLayout(){
    loginScreen.style.display = "none";
    authModal.classList.remove("show");
    document.getElementById("map").style.display = "block";
    document.getElementById("searchInput").style.display = "block";

    const addBtn = document.getElementById("addMarkerBtn");
    const lockBtn = document.getElementById("lockBtn");
    const exportBtn = document.getElementById("exportBtn");

    if(userRole === "guest"){
      addBtn.style.display = "none";
      lockBtn.style.display = "none";
      exportBtn.style.display = "none";
    }else{
      addBtn.style.display = "flex";
      lockBtn.style.display = userRole === "admin" ? "flex" : "none";
      exportBtn.style.display = "flex";
    }

    setTimeout(()=> {
      map.invalidateSize();
      map.fitBounds(bounds);
    }, 250);
  }

  /* =========================
     6) LEAFLET MAP (CRS.Simple)
     ========================= */
  const bounds = [[SOUTH, WEST], [NORTH, EAST]];

  const map = L.map("map", {
    crs: L.CRS.Simple,
    minZoom: -4,
    maxZoom: 4,
    zoomSnap: 0.25,
    zoomDelta: 0.25,
    zoomControl: false
  });

  L.control.zoom({ position: "bottomright" }).addTo(map);

  const overlay = L.imageOverlay(MAP_IMAGE, bounds).addTo(map);

  map.fitBounds(bounds);
  map.setMaxBounds(bounds);
  map.on("drag", () => map.panInsideBounds(bounds, { animate:false }));

  // Cluster
  const markersCluster = L.markerClusterGroup({
    disableClusteringAtZoom: 2,
    spiderfyOnMaxZoom: true,
    showCoverageOnHover: false
  });
  map.addLayer(markersCluster);

  const markers = {}; // key -> marker
  let lastActiveMarker = null;

  function createNumberIcon(text){
    const safe = (text ?? "").toString().replace(/</g,"&lt;").replace(/>/g,"&gt;");
    return L.divIcon({
      className: "custom-div-icon",
      html: `<div class="pin-wrapper">
              <div class="pin-marker" data-pin="${safe}"></div>
              <div class="pin-number">${safe}</div>
            </div>`,
      iconSize: [50,60],
      iconAnchor: [25,60]
    });
  }

  /* =========================
     7) EKLEME MODU + MODALLAR
     ========================= */
  let addingMarkerMode = false;
  let tempLatLng = null;         // CRS.Simple => {lat:N, lng:E}
  let markerToDelete = null;

  const addMarkerBtn = document.getElementById("addMarkerBtn");
  const addModal = document.getElementById("addModal");
  const markerNumber = document.getElementById("markerNumber");

  addMarkerBtn.addEventListener("click", ()=>{
    addingMarkerMode = !addingMarkerMode;

    if(addingMarkerMode){
      addMarkerBtn.classList.add("active");
      addMarkerBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>';
      map.getContainer().classList.add("crosshair-cursor-enabled");
      closeNavPanel();
      deactivateLastMarker();
    }else{
      addMarkerBtn.classList.remove("active");
      addMarkerBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>';
      map.getContainer().classList.remove("crosshair-cursor-enabled");
    }
  });

  document.getElementById("btnAddCancel").addEventListener("click", ()=>{
    addModal.classList.remove("show");
    tempLatLng = null;
  });

  document.getElementById("btnAddSave").addEventListener("click", async ()=>{
    const title = markerNumber.value.trim();
    if(!title || !tempLatLng) return;

    // Kaydedilecek ham koordinat (tıklanan) => UTM gibi (E = lng, N = lat)
    // Biz ekrana çizimde offset uygulanmış koordinat kullanacağız.
    // Burada "ham" değil, doğrudan offset uygulanmış hali saklayacağız ki
    // her cihazda aynı görünsün:
    const E0 = tempLatLng.lng;
    const N0 = tempLatLng.lat;
    const p = applyOffset(E0, N0);

    await push(pointsRef, {
      title,
      E: p.E,
      N: p.N,
      createdAt: Date.now()
    });

    addModal.classList.remove("show");
    tempLatLng = null;
    addingMarkerMode = false;
    addMarkerBtn.classList.remove("active");
    addMarkerBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>';
    map.getContainer().classList.remove("crosshair-cursor-enabled");
  });

  // Harita tıklaması
  map.on("click", (e)=>{
    // Nav panel kapat
    if(!addingMarkerMode && !navigationActive){
      closeNavPanel();
      deactivateLastMarker();
    }

    // Ekleme modu
    if(addingMarkerMode){
      tempLatLng = e.latlng; // CRS.Simple => lat=N, lng=E
      addModal.classList.add("show");
      markerNumber.value = "";
      setTimeout(()=> markerNumber.focus(), 60);
    }
  });

  /* =========================
     8) MARKER OLUŞTURMA + TIKLAMA
     ========================= */
  function deactivateLastMarker(){
    if(!lastActiveMarker) return;
    const el = lastActiveMarker.getElement();
    if(el){
      el.querySelector(".pin-marker")?.classList.remove("active");
      el.querySelector(".pin-wrapper")?.classList.remove("bounce-anim");
    }
    lastActiveMarker = null;
  }

  function selectMarker(marker, data){
    deactivateLastMarker();

    const el = marker.getElement();
    if(el){
      el.querySelector(".pin-marker")?.classList.add("active");
      el.querySelector(".pin-wrapper")?.classList.add("bounce-anim");
    }
    lastActiveMarker = marker;

    // Panel
    document.getElementById("navTargetTitle").innerText = "İstif: " + data.title;
    document.getElementById("navDistance").innerText = "-- m";
    document.getElementById("bottomNavPanel").classList.add("active");

    currentTargetEN = { E: data.E, N: data.N };

    // Start/Stop butonları
    if(navigationActive){
      document.getElementById("btnStartNav").style.display = "none";
      document.getElementById("btnStopNav").style.display = "block";
    }else{
      document.getElementById("btnStartNav").style.display = "flex";
      document.getElementById("btnStopNav").style.display = "none";
    }

    // Sil butonu (sadece admin + edit mode)
    const delBtn = document.getElementById("btnPanelDelete");
    if(userRole === "admin" && isEditMode){
      delBtn.style.display = "block";
      delBtn.onclick = ()=>{
        markerToDelete = { key: marker.firebaseKey, marker };
        document.getElementById("deleteModal").classList.add("show");
      };
    }else{
      delBtn.style.display = "none";
    }
  }

  function createMarker(key, d){
    if(typeof d?.E !== "number" || typeof d?.N !== "number") return null;

    const marker = L.marker([d.N, d.E], {
      icon: createNumberIcon(d.title || "?"),
      draggable: (userRole === "admin" && isEditMode)
    });
    marker.firebaseKey = key;
    marker.myTitle = d.title;

    marker.on("dragend", async ()=>{
      if(!(userRole === "admin" && isEditMode)) return;

      const pos = marker.getLatLng(); // lat=N, lng=E
      // Yeni pozisyonu direkt veritabanına yaz
      try{
        await update(ref(db, "goldag_saha/" + key), { N: pos.lat, E: pos.lng });
      }catch(e){
        // hata olursa geri al
        marker.setLatLng([d.N, d.E]);
      }
    });

    marker.on("click", (ev)=>{
      // sürükleme sırasında tıklamayı yok say
      if(marker.dragging && marker.dragging.enabled() && marker._isDragging) return;
      L.DomEvent.stopPropagation(ev);

      // Marker verisini firebase’den değil marker objesinden okuruz (güncel)
      const current = marker.__data || d;
      selectMarker(marker, current);
      map.setView(marker.getLatLng(), Math.max(map.getZoom(), 0));
    });

    // marker üstünde data sakla
    marker.__data = d;

    return marker;
  }

  /* =========================
     9) FIREBASE CANLI SENKRON
     ========================= */
  onChildAdded(pointsRef, (snap)=>{
    if(markers[snap.key]) return;
    const d = snap.val();
    const marker = createMarker(snap.key, d);
    if(marker){
      markers[snap.key] = marker;
      markersCluster.addLayer(marker);
    }
  });

  onChildChanged(pointsRef, (snap)=>{
    const marker = markers[snap.key];
    if(!marker) return;

    const d = snap.val();
    marker.__data = d;
    marker.myTitle = d.title;
    marker.setLatLng([d.N, d.E]);
    marker.setIcon(createNumberIcon(d.title || "?"));
  });

  onChildRemoved(pointsRef, (snap)=>{
    const marker = markers[snap.key];
    if(marker){
      markersCluster.removeLayer(marker);
      delete markers[snap.key];
    }
    closeNavPanel();
    deactivateLastMarker();
  });

  /* =========================
     10) SİLME
     ========================= */
  document.getElementById("btnDeleteCancel").addEventListener("click", ()=>{
    document.getElementById("deleteModal").classList.remove("show");
    markerToDelete = null;
  });

  document.getElementById("btnDeleteConfirm").addEventListener("click", async ()=>{
    if(!markerToDelete) return;
    try{
      await remove(ref(db, "goldag_saha/" + markerToDelete.key));
    }catch(e){
      alert("Silme hatası: " + e.message);
    }
    document.getElementById("deleteModal").classList.remove("show");
    markerToDelete = null;
  });

  /* =========================
     11) KİLİT (ADMIN EDIT MODE)
     ========================= */
  const lockBtn = document.getElementById("lockBtn");
  lockBtn.addEventListener("click", ()=>{
    if(userRole !== "admin") return;

    isEditMode = !isEditMode;
    lockBtn.classList.toggle("unlocked", isEditMode);
    document.getElementById("map").classList.toggle("map-edit-active", isEditMode);

    lockBtn.innerHTML = isEditMode
      ? '<svg viewBox="0 0 24 24"><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm
